doctype html
html
  head
    title Editar Turno
    link(rel='stylesheet', href='/styles.css')
  body
    h1 Editar Turno

    form(action=`/turnos/${turno.id}/editar`, method='POST')

      div
        label Paciente:
        select(name='paciente_id' required)
          each p in pacientes
            option(
              value=p.id
              selected=(p.id == turno.paciente_id)
            )= p.nombre

      div
        label Profesional:
        select(name='profesional_id' id='profesional_id' required)
          each pr in profesionales
            option(
              value=pr.id
              selected=(pr.id == turno.profesional_id)
            )= pr.nombre_completo

      div
        label Especialidad:
        select(name='especialidad_id' id='especialidad_id' required)
          option(value='') Selecciona especialidad

      div
        label Sucursal:
        select(name='sucursal_id' required)
          each s in sucursales
            option(
              value=s.id
              selected=(s.id == turno.sucursal_id)
            )= s.nombre

      div
        label Fecha:
        input(type='date', name='fecha', id='fecha', value=turno.fecha, required)

      div
        label Hora:
        input(type='time', name='hora', value=turno.hora, required)

      div
        label Estado:
        select(name='estado')
          option(value='pendiente' selected=turno.estado=='pendiente') Pendiente
          option(value='confirmado' selected=turno.estado=='confirmado') Confirmado
          option(value='cancelado' selected=turno.estado=='cancelado') Cancelado

      button(type='submit') Guardar Cambios

    a(href='/turnos') Volver


    // ==========================
    // FILTRAR ESPECIALIDADES POR PROFESIONAL
    // ==========================
    script.
      document.addEventListener('DOMContentLoaded', () => {
        const profesionalSelect = document.getElementById('profesional_id');
        const especialidadSelect = document.getElementById('especialidad_id');

        const especialidadActual = #{turno.especialidad_id};

        function cargarEspecialidades() {
          const profesionalId = profesionalSelect.value;

          if (!profesionalId) return;

          fetch(`/profesionales/${profesionalId}/especialidades`)

            .then(res => res.json())
            .then(especialidades => {
              especialidadSelect.innerHTML = '<option value="">Selecciona especialidad</option>';

              especialidades.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = e.nombre;

                if (e.id == especialidadActual) {
                  opt.selected = true;
                }

                especialidadSelect.appendChild(opt);
              });
            })
            .catch(() => {
              especialidadSelect.innerHTML = '<option>Error cargando especialidades</option>';
            });
        }

        // cargar al entrar
        cargarEspecialidades();

        // recargar si cambia profesional
        profesionalSelect.addEventListener('change', cargarEspecialidades);
      });
