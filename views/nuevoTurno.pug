doctype html
html
  head
    title Crear Nuevo Turno
    link(rel='stylesheet', href='/styles.css')
  body
    h1 Crear Nuevo Turno

    form(action='/turnos', method='POST')

      div
        label Paciente:
        select(name='paciente_id' required)
          option(value='') Selecciona un paciente
          each p in pacientes
            option(value=p.id)= p.nombre

      div
        label Especialidad:
        select(name='especialidad_id' id='especialidad_id' required)
          option(value='') Selecciona una especialidad
          each especialidad in especialidades
            option(value=especialidad.id)= especialidad.nombre

      div
        label Profesional:
        select(name='profesional_id' id='profesional_id' required)
          option(value='') Selecciona un profesional

      div
        label Sucursal:
        select(name='sucursal_id' required)
          option(value='') Selecciona una sucursal
          each sucursal in sucursales
            option(value=sucursal.id)= sucursal.nombre

      div
        label Fecha:
        input(type='date', name='fecha', id='fecha', required)

      div
        label Hora:
        select(name='hora', id='hora', required)
          option(value='') Selecciona un horario

      div
        button(type='submit') Crear Turno

    a(href='/turnos') Volver a la lista de turnos

    // ======================
    // JS para carga dinÃ¡mica de horarios
    // ======================
    script.
      document.addEventListener('DOMContentLoaded', () => {
        const especialidad = document.getElementById('especialidad_id');
        const profesional = document.getElementById('profesional_id');
        const fecha = document.getElementById('fecha');
        const hora = document.getElementById('hora');

        // Cambia profesionales segÃºn especialidad
        especialidad.addEventListener('change', () => {
          fetch(`/profesionales/especialidad/${especialidad.value}`)
            .then(r => r.json())
            .then(data => {
              profesional.innerHTML = '<option value="">Selecciona un profesional</option>';
              data.forEach(p => {
                profesional.innerHTML += `<option value="${p.id}">${p.nombre_completo}</option>`;
              });
            });
        });

        // FunciÃ³n principal para cargar horarios
        function cargarHorarios() {
          if (!profesional.value || !fecha.value) return;

          const fechaValor = fecha.value.trim();

          // â›” validar formato de fecha YYYY-MM-DD
          if (!/^\d{4}-\d{2}-\d{2}$/.test(fechaValor)) {
            console.warn('Fecha invÃ¡lida:', fechaValor);
            return;
          }

          fetch(`/turnos/horarios-disponibles/${profesional.value}/${fechaValor}`, {
            cache: "no-store"
          })
            .then(r => r.json())
            .then(data => {
              hora.innerHTML = '';

              // ðŸš« si backend devuelve motivo (feriado, fin de semana, vacaciones)
              if (data.motivo) {
                const mensajes = {
                  fin_de_semana: 'No se atiende sÃ¡bados ni domingos',
                  feriado: 'Es feriado â€” no hay atenciÃ³n',
                  sin_agenda: 'El profesional no atiende este dÃ­a',
                  vacaciones: 'El profesional estÃ¡ de vacaciones'
                };
                const option = document.createElement('option');
                option.textContent = mensajes[data.motivo] || 'No hay atenciÃ³n';
                option.disabled = true;
                hora.appendChild(option);
                return;
              }

              // Si no hay horarios
              if (!data.length) {
                const option = document.createElement('option');
                option.textContent = 'No hay horarios disponibles';
                option.disabled = true;
                hora.appendChild(option);
                return;
              }

              // Cargar horarios disponibles
              hora.innerHTML = '<option value="">Selecciona un horario</option>';
              data.forEach(h => {
                const option = document.createElement('option');
                option.value = h;
                option.textContent = h;
                hora.appendChild(option);
              });
            });
        }

        profesional.addEventListener('change', cargarHorarios);
        fecha.addEventListener('change', cargarHorarios);
      });
